// services/googlePlacesService.js
const axios = require('axios');

const GOOGLE_API_KEY = process.env.GOOGLE_API_KEY;
const PLACES_API_URL = 'https://maps.googleapis.com/maps/api/place';

const getPlacesByCity = async (cityName) => {
  try {
    // Step 1: Get the geographical coordinates of the city
    const geocodeResponse = await axios.get(`${PLACES_API_URL}/geocode/json`, {
      params: {
        address: cityName,
        key: GOOGLE_API_KEY,
      },
    });

    if (geocodeResponse.data.status !== 'OK') {
      throw new Error('Geocoding failed');
    }

    const { lat, lng } = geocodeResponse.data.results[0].geometry.location;

    // Step 2: Find places within the city using the coordinates
    const placesResponse = await axios.get(`${PLACES_API_URL}/nearbysearch/json`, {
      params: {
        location: `${lat},${lng}`,
        radius: 50000, // Adjust radius as needed (in meters)
        key: GOOGLE_API_KEY,
      },
    });

    if (placesResponse.data.status !== 'OK') {
      throw new Error('Places search failed');
    }

    return placesResponse.data.results;
  } catch (error) {
    console.error(`Error fetching places for city ${cityName}:`, error.message);
    throw error;
  }
};

module.exports = {
  getPlacesByCity,
};
